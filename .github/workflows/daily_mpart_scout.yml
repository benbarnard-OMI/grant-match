name: Daily MPART Grant Scout v2

on:
  # Run daily at 11:00 UTC (6:00 AM CST)
  schedule:
    - cron: '0 11 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      run_email_digest:
        description: 'Send email digest after scouting'
        required: false
        default: 'true'
      export_excel:
        description: 'Generate Excel export'
        required: false
        default: 'true'
      include_foundations:
        description: 'Include foundation sources (RWJF, Commonwealth, etc.)'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'

jobs:
  scout-grants:
    name: Scout for MPART Grant Opportunities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright requests beautifulsoup4 lxml pandas openpyxl
      
      - name: Install Playwright browsers
        run: |
          playwright install chromium
      
      - name: Run MPART Grant Scout
        env:
          DATA_GOV_API_KEY: ${{ secrets.DATA_GOV_API_KEY }}
        run: |
          echo "ðŸš€ Starting MPART Grant Scout pipeline..."
          echo "Sources: Illinois GATA, SAM.gov"
          CMD="python src/scout_il.py --live"
          if [ \"${{ github.event.inputs.include_foundations }}\" = \"true\" ]; then
            CMD=\"$CMD --include-foundations\"
            echo "Including foundation sources"
          fi
          $CMD
          echo "âœ… Scout completed"
        continue-on-error: true
      
      - name: Generate Excel Export
        if: github.event.inputs.export_excel != 'false'
        run: |
          echo "ðŸ“Š Generating Excel export..."
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from export.excel_exporter import export_matches_to_excel
          try:
              path = export_matches_to_excel()
              print(f'âœ… Excel exported to: {path}')
          except Exception as e:
              print(f'âš ï¸ Excel export skipped: {e}')
          "
        continue-on-error: true
      
      - name: Generate Calendar File
        run: |
          echo "ðŸ“… Generating calendar file..."
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from integrations.calendar import generate_deadline_calendar
          try:
              path = generate_deadline_calendar()
              print(f'âœ… Calendar exported to: {path}')
          except Exception as e:
              print(f'âš ï¸ Calendar export skipped: {e}')
          "
        continue-on-error: true
      
      - name: Send Email Digest
        if: github.event.inputs.run_email_digest != 'false'
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_ADDRESS: ${{ secrets.FROM_ADDRESS || 'mpart-grants@uis.edu' }}
          TO_ADDRESSES: ${{ secrets.TO_ADDRESSES }}
          SEND_DAILY_DIGEST: 'true'
        run: |
          echo "ðŸ“§ Sending email digest..."
          python -c "
          import sys
          sys.path.insert(0, 'src')
          import json
          from notifications.email_notifier import EmailNotifier
          
          try:
              with open('data/mpart_matches.json') as f:
                  data = json.load(f)
              
              matches = data.get('matches', [])
              stats = data.get('summary', {})
              
              notifier = EmailNotifier()
              success = notifier.send_digest(matches, stats)
              
              if success:
                  print('âœ… Email digest sent successfully')
              else:
                  print('âš ï¸ Email digest failed (check SMTP configuration)')
          except Exception as e:
              print(f'âš ï¸ Email digest skipped: {e}')
          "
        continue-on-error: true
      
      - name: Check for new matches
        id: check_matches
        run: |
          if [ -f "data/mpart_matches.json" ]; then
            MATCH_COUNT=$(python3 -c "import json; data=json.load(open('data/mpart_matches.json')); print(len(data.get('matches', [])))" 2>/dev/null || echo "0")
            HIGH_PRIORITY=$(python3 -c "import json; data=json.load(open('data/mpart_matches.json')); print(len([m for m in data.get('matches', []) if m.get('match_score', 0) >= 80]))" 2>/dev/null || echo "0")
            echo "Found $MATCH_COUNT total matches ($HIGH_PRIORITY high priority)"
            echo "match_count=$MATCH_COUNT" >> $GITHUB_OUTPUT
            echo "high_priority=$HIGH_PRIORITY" >> $GITHUB_OUTPUT
            
            # Check if file was modified
            if git diff --quiet data/mpart_matches.json 2>/dev/null; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "No new matches to commit"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "New matches found - will commit changes"
            fi
          else
            echo "match_count=0" >> $GITHUB_OUTPUT
            echo "high_priority=0" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No matches file found"
          fi
      
      - name: Configure Git
        if: steps.check_matches.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: Commit and push new matches
        if: steps.check_matches.outputs.has_changes == 'true'
        run: |
          git add data/*.json 2>/dev/null || true
          git add data/*.xlsx 2>/dev/null || true
          git add data/*.ics 2>/dev/null || true
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          MATCH_COUNT=${{ steps.check_matches.outputs.match_count }}
          HIGH_PRIORITY=${{ steps.check_matches.outputs.high_priority }}
          
          git commit -m "ðŸ¤– Daily Scout v2: $MATCH_COUNT matches ($HIGH_PRIORITY high priority) on $TIMESTAMP

          - Illinois GATA portal scanned
          - SAM.gov federal opportunities queried
          - Foundation sources checked (RWJF, Commonwealth, etc.)
          - Excel export generated
          - Calendar file generated
          - Email digest sent (if configured)
          
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}" || echo "No changes to commit"
          
          git push
          echo "âœ… Successfully committed and pushed"
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scout-results-${{ github.run_number }}
          path: |
            data/*.json
            data/*.xlsx
            data/*.ics
          retention-days: 30
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ MPART Daily Scout v2 Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_matches.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **New matches found and committed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Matches | ${{ steps.check_matches.outputs.match_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "| High Priority | ${{ steps.check_matches.outputs.high_priority }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Timestamp | $(date -u +"%Y-%m-%d %H:%M UTC") |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
            echo "- [mpart_matches.json](./data/mpart_matches.json)" >> $GITHUB_STEP_SUMMARY
            echo "- Excel export (.xlsx)" >> $GITHUB_STEP_SUMMARY
            echo "- Calendar file (.ics)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No new matches today**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The scout ran successfully but no new high-quality matches were found." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "- Run briefing: \`python src/student_briefing_v2.py\`" >> $GITHUB_STEP_SUMMARY
          echo "- View dashboard: \`streamlit run src/dashboard/app.py\`" >> $GITHUB_STEP_SUMMARY
